<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .submenu-enter { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.4s ease-out; }
        .submenu-enter-active { max-height: 500px; opacity: 1; margin-top: 1rem; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased p-4 pb-10">

    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <div id="avatar-container" class="w-12 h-12 rounded-full bg-indigo-500 flex items-center justify-center text-xl font-bold overflow-hidden border border-gray-700">
                <span id="avatar-initial">–ì</span>
            </div>
            <div>
                <h1 id="user-name" class="text-xl font-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <p class="text-gray-400 text-xs">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è: <span id="total-xp" class="text-white font-bold">0</span></p>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 mb-8 border border-gray-700 shadow-lg">
        <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</p>
        <div class="flex items-end gap-3 mb-2">
            <h2 id="month-xp" class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">0</h2>
            <span class="text-gray-400 mb-2 font-bold">–æ—á–∫–æ–≤</span>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between text-sm">
            <span class="text-gray-400">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü:</span>
            <span id="last-month-xp" class="font-bold text-white">0</span>
        </div>
    </div>

    <h2 class="text-lg font-bold mb-4">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏</h2>

    <div class="flex overflow-x-auto no-scrollbar gap-4 pb-2">
        <button onclick="toggleMenu('menu-sport')" class="min-w-[140px] bg-gray-800 p-4 rounded-2xl border border-gray-700 active:scale-95 transition-transform text-left">
            <div class="text-emerald-400 mb-2 text-2xl">üèÉ‚Äç‚ôÇÔ∏è</div>
            <h3 class="font-bold">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
        </button>

        <button onclick="toggleMenu('menu-family')" class="min-w-[140px] bg-gray-800 p-4 rounded-2xl border border-gray-700 active:scale-95 transition-transform text-left">
            <div class="text-blue-400 mb-2 text-2xl">üë®‚Äçüë©‚Äçüë¶</div>
            <h3 class="font-bold">–°–µ–º—å—è</h3>
        </button>

        <button onclick="toggleMenu('menu-rest')" class="min-w-[140px] bg-gray-800 p-4 rounded-2xl border border-gray-700 active:scale-95 transition-transform text-left">
            <div class="text-purple-400 mb-2 text-2xl">üéÆ</div>
            <h3 class="font-bold">–û—Ç–¥—ã—Ö</h3>
        </button>
    </div>

    <div id="menu-sport" class="submenu-enter bg-gray-800 rounded-2xl p-4">
        <h4 class="font-bold text-emerald-400 mb-3">–ó–∞–¥–∞—á–∏: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
        <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-xl">
                <input type="checkbox" id="task-run" onclick="addXP(150, this)" class="w-6 h-6 rounded text-emerald-500 bg-gray-800 border-gray-600 focus:ring-emerald-500">
                <span class="flex-1">–ü—Ä–æ–±–µ–∂–∫–∞</span>
                <span class="text-emerald-400 font-bold">+150</span>
            </label>
            <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-xl">
                <input type="checkbox" id="task-pushups" onclick="addXP(50, this)" class="w-6 h-6 rounded text-emerald-500 bg-gray-800 border-gray-600 focus:ring-emerald-500">
                <span class="flex-1">–û—Ç–∂–∏–º–∞–Ω–∏—è / –¢—É—Ä–Ω–∏–∫</span>
                <span class="text-emerald-400 font-bold">+50</span>
            </label>
        </div>
    </div>

    <div id="menu-family" class="submenu-enter bg-gray-800 rounded-2xl p-4">
        <h4 class="font-bold text-blue-400 mb-3">–ó–∞–¥–∞—á–∏: –°–µ–º—å—è</h4>
        <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-xl">
                <input type="checkbox" id="task-kids" onclick="addXP(100, this)" class="w-6 h-6 rounded text-blue-500">
                <span class="flex-1">–í—Ä–µ–º—è —Å –í–∏—Ç—é—à–µ–π –∏ –î–∏–º—É–ª–µ–π</span>
                <span class="text-emerald-400 font-bold">+100</span>
            </label>
        </div>
    </div>

    <div id="menu-rest" class="submenu-enter bg-gray-800 rounded-2xl p-4">
        <h4 class="font-bold text-purple-400 mb-3">–ó–∞–¥–∞—á–∏: –û—Ç–¥—ã—Ö</h4>
        <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-xl">
                <input type="checkbox" id="task-console" onclick="addXP(30, this)" class="w-6 h-6 rounded text-purple-500">
                <span class="flex-1">–°—ã–≥—Ä–∞—Ç—å –≤ –ø—Ä–∏—Å—Ç–∞–≤–∫—É</span>
                <span class="text-emerald-400 font-bold">+30</span>
            </label>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const backendUrl = "https://rpg-backend-yg16.onrender.com";
        let username = "–ì–æ—Å—Ç—å";

        const user = tg.initDataUnsafe?.user;
        if (user) {
            username = user.first_name;
            document.getElementById('user-name').textContent = username;
            const avatarContainer = document.getElementById('avatar-container');
            if (user.photo_url) {
                avatarContainer.innerHTML = `<img src="${user.photo_url}" alt="Avatar" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('avatar-initial').textContent = username.charAt(0).toUpperCase();
            }
        }

        const todayDate = new Date().toDateString();
        let savedData = JSON.parse(localStorage.getItem('rpgTasks_v2')) || { date: '', tasks: [] };

        if (savedData.date !== todayDate) {
            savedData = { date: todayDate, tasks: [] };
            localStorage.setItem('rpgTasks_v2', JSON.stringify(savedData));
        }

        function markAsDone(element) {
            element.checked = true;
            element.disabled = true;
            element.parentElement.style.opacity = '0.5';
        }

        function loadSavedTasks() {
            savedData.tasks.forEach(taskId => {
                const checkbox = document.getElementById(taskId);
                if (checkbox) markAsDone(checkbox);
            });
        }

        function updateUI(total_xp, current_month_xp, last_month_xp) {
            document.getElementById('total-xp').textContent = total_xp;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ü–∏—Ñ—Ä –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            const monthElement = document.getElementById('month-xp');
            monthElement.textContent = current_month_xp; 
            
            document.getElementById('last-month-xp').textContent = last_month_xp;
        }

        async function loadHero() {
            try {
                let response = await fetch(`${backendUrl}/get_hero/${username}`);
                let data = await response.json();
                updateUI(data.total_xp, data.current_month_xp, data.last_month_xp);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error);
            }
        }

        async function addXP(amount, element) {
            const taskId = element.id;
            markAsDone(element);
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            if (!savedData.tasks.includes(taskId)) {
                savedData.tasks.push(taskId);
                localStorage.setItem('rpgTasks_v2', JSON.stringify(savedData));
            }

            try {
                let response = await fetch(`${backendUrl}/add_xp/${username}?amount=${amount}`, { method: 'POST' });
                let data = await response.json();
                updateUI(data.total_xp, data.current_month_xp, data.last_month_xp);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø—ã—Ç–∞", error);
            }
        }

        function toggleMenu(menuId) {
            const allMenus = document.querySelectorAll('.submenu-enter');
            allMenus.forEach(menu => {
                if(menu.id !== menuId) menu.classList.remove('submenu-enter-active');
            });
            document.getElementById(menuId).classList.toggle('submenu-enter-active');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        loadHero();
        loadSavedTasks();
    </script>
</body>
</html>
