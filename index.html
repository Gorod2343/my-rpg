<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { color: #34d399; border-bottom: 2px solid #34d399; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans p-4 pb-24">

    <div class="flex justify-between items-center mb-3">
        <div class="flex items-center gap-3">
            <div id="avatar-container" class="w-12 h-12 rounded-full bg-indigo-500 flex items-center justify-center text-xl font-bold border border-gray-700 shadow-lg overflow-hidden">
                <span id="avatar-initial">–ì</span>
            </div>
            <div>
                <h1 id="user-name" class="text-xl font-bold text-white">–ì–æ—Å—Ç—å</h1>
                <p class="text-gray-400 text-xs">–í—Å–µ–≥–æ: <span id="total-xp" class="text-white font-bold">0</span></p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xs text-red-400 font-bold uppercase tracking-wider">–ó–¥–æ—Ä–æ–≤—å–µ</p>
            <p class="font-bold text-lg"><span id="user-hp">100</span><span class="text-sm text-gray-500">/100</span></p>
        </div>
    </div>

    <div class="w-full bg-gray-800 rounded-full h-2 mb-6 border border-gray-700 overflow-hidden shadow-inner">
        <div id="hp-bar" class="bg-gradient-to-r from-red-600 to-red-400 h-2 transition-all duration-500" style="width: 100%;"></div>
    </div>

    <div id="tab-tasks">
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 mb-6 border border-gray-700 shadow-xl">
            <p class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-1">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–∫—É–ø–æ–∫</p>
            <div class="flex items-end gap-2 mb-2">
                <h2 id="month-xp" class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">0</h2>
                <span class="text-gray-400 mb-2 font-bold uppercase text-xs">–æ—á–∫–æ–≤</span>
            </div>
        </div>

        <div class="bg-gray-800 rounded-2xl p-4 mb-6 border border-gray-700 shadow-lg">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-cyan-400">üíß –ë–∞–∑–∞: –í–æ–¥–∞</h4>
                <span class="text-emerald-400 text-xs font-bold">+5 –û—á–∫–æ–≤</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-water" onclick="drinkWater()" class="bg-cyan-600 w-10 h-10 rounded-lg flex items-center justify-center text-lg active:scale-95 transition-transform">ü•§</button>
                <div class="flex-1">
                    <div class="flex justify-between text-[10px] text-gray-500 uppercase font-bold mb-1">
                        <span id="water-text">0 / 8 —Å—Ç–∞–∫–∞–Ω–æ–≤</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-1.5">
                        <div id="water-progress" class="bg-cyan-400 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="toggleMenu('menu-sport')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 text-left">
                <div class="text-2xl mb-1">üèÉ‚Äç‚ôÇÔ∏è</div>
                <div class="font-bold text-sm">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </button>
            <button onclick="toggleMenu('menu-family')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 text-left">
                <div class="text-2xl mb-1">üë®‚Äçüë©‚Äçüë¶</div>
                <div class="font-bold text-sm">–°–µ–º—å—è</div>
            </button>
        </div>

        <div id="menu-sport" class="hidden mt-4 space-y-2">
            <label class="flex items-center gap-3 p-4 bg-gray-800 rounded-xl border border-gray-700">
                <input type="checkbox" id="task-run" onclick="addXP(150, this)" class="w-5 h-5 rounded text-emerald-500">
                <span class="flex-1 text-sm">–ü—Ä–æ–±–µ–∂–∫–∞</span>
                <span class="text-emerald-400 font-bold text-xs">+150</span>
            </label>
        </div>

        <div id="menu-family" class="hidden mt-4 space-y-2">
            <label class="flex items-center gap-3 p-4 bg-gray-800 rounded-xl border border-gray-700">
                <input type="checkbox" id="task-kids" onclick="addXP(100, this)" class="w-5 h-5 rounded text-blue-500">
                <span class="flex-1 text-sm">–í—Ä–µ–º—è —Å –í–∏—Ç—é—à–µ–π –∏ –î–∏–º—É–ª–µ–π</span>
                <span class="text-emerald-400 font-bold text-xs">+100</span>
            </label>
        </div>
    </div>

    <div id="tab-shop" class="hidden">
        <h2 class="text-xl font-black mb-6 uppercase tracking-tight">–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥ üõí</h2>
        <div class="grid grid-cols-1 gap-4">
            <div onclick="buyReward(100, '–®–æ–∫–æ–ª–∞–¥–∫–∞')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center active:scale-95 transition-transform shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üç´</div>
                    <div>
                        <div class="font-bold">–®–æ–∫–æ–ª–∞–¥–Ω—ã–π –±–∞—Ç–æ–Ω—á–∏–∫</div>
                        <div class="text-xs text-gray-500">–ú–∞–ª–µ–Ω—å–∫–∞—è —Ä–∞–¥–æ—Å—Ç—å</div>
                    </div>
                </div>
                <div class="text-amber-400 font-black">100 XP</div>
            </div>

            <div onclick="buyReward(150, '–ì–∞–∑–∏—Ä–æ–≤–∫–∞')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center active:scale-95 transition-transform shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">ü•§</div>
                    <div>
                        <div class="font-bold">–ì–∞–∑–∏—Ä–æ–≤–∫–∞</div>
                        <div class="text-xs text-gray-500">–û—Å–≤–µ–∂–∞—é—â–∏–π –¥–æ—Ñ–∞–º–∏–Ω</div>
                    </div>
                </div>
                <div class="text-amber-400 font-black">150 XP</div>
            </div>

            <div onclick="buyReward(200, '–í—ã–ø–µ—á–∫–∞')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center active:scale-95 transition-transform shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">ü•ê</div>
                    <div>
                        <div class="font-bold">–°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞</div>
                        <div class="text-xs text-gray-500">–£—Ç—Ä–µ–Ω–Ω–∏–π –±–æ–Ω—É—Å</div>
                    </div>
                </div>
                <div class="text-amber-400 font-black">200 XP</div>
            </div>

            <div onclick="buyReward(300, '–°–Ω–µ–∫–∏')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center active:scale-95 transition-transform shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üçø</div>
                    <div>
                        <div class="font-bold">–°–Ω–µ–∫–∏ / –ß–∏–ø—Å—ã</div>
                        <div class="text-xs text-gray-500">–î–ª—è –≤–µ—á–µ—Ä–Ω–µ–≥–æ –∫–∏–Ω–æ</div>
                    </div>
                </div>
                <div class="text-amber-400 font-black">300 XP</div>
            </div>

            <div onclick="buyReward(600, '–§–∞—Å—Ç –§—É–¥')" class="bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center active:scale-95 transition-transform shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">üçî</div>
                    <div>
                        <div class="font-bold text-red-400 uppercase">–§–∞—Å—Ç –§—É–¥</div>
                        <div class="text-xs text-gray-500">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –æ–±–µ–¥</div>
                    </div>
                </div>
                <div class="text-amber-400 font-black">600 XP</div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur-md border-t border-gray-800 p-3 flex justify-around shadow-2xl z-50">
        <button onclick="showTab('tasks')" id="nav-tasks" class="flex flex-col items-center gap-1 tab-active transition-all">
            <span class="text-xl">üìà</span>
            <span class="text-[10px] font-bold uppercase">–ü—Ä–∏–≤—ã—á–∫–∏</span>
        </button>
        <button onclick="showTab('shop')" id="nav-shop" class="flex flex-col items-center gap-1 text-gray-500 transition-all">
            <span class="text-xl">üõí</span>
            <span class="text-[10px] font-bold uppercase">–ú–∞–≥–∞–∑–∏–Ω</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const backendUrl = "https://rpg-backend-yg16.onrender.com";
        let username = "–ì–æ—Å—Ç—å";

        const user = tg.initDataUnsafe?.user;
        if (user && user.first_name) {
            username = user.first_name;
            document.getElementById('user-name').textContent = username;
            if (user.photo_url) document.getElementById('avatar-container').innerHTML = `<img src="${user.photo_url}" class="w-full h-full object-cover">`;
        }

        function showTab(name) {
            document.getElementById('tab-tasks').classList.toggle('hidden', name !== 'tasks');
            document.getElementById('tab-shop').classList.toggle('hidden', name !== 'shop');
            document.getElementById('nav-tasks').classList.toggle('tab-active', name === 'tasks');
            document.getElementById('nav-tasks').classList.toggle('text-gray-500', name !== 'tasks');
            document.getElementById('nav-shop').classList.toggle('tab-active', name === 'shop');
            document.getElementById('nav-shop').classList.toggle('text-gray-500', name !== 'shop');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function toggleMenu(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI(data) {
            document.getElementById('total-xp').textContent = data.total_xp;
            document.getElementById('month-xp').textContent = data.current_month_xp;
            document.getElementById('user-hp').textContent = data.hp;
            document.getElementById('hp-bar').style.width = data.hp + '%';
            
            // –í–æ–¥–∞
            document.getElementById('water-text').textContent = `${data.water_count} / 8 —Å—Ç–∞–∫–∞–Ω–æ–≤`;
            document.getElementById('water-progress').style.width = (data.water_count / 8 * 100) + '%';
            const wBtn = document.getElementById('btn-water');
            wBtn.disabled = data.water_count >= 8;
            wBtn.innerHTML = data.water_count >= 8 ? '‚úÖ' : 'ü•§';

            // –ì–∞–ª–æ—á–∫–∏
            document.querySelectorAll('input[type="checkbox"]').forEach(c => {
                const done = data.completed_tasks.split(',').includes(c.id);
                c.checked = done; c.disabled = done;
                c.parentElement.style.opacity = done ? '0.4' : '1';
            });
        }

        async function loadHero() {
            try {
                const r = await fetch(`${backendUrl}/get_hero/${username}`);
                updateUI(await r.json());
            } catch (e) { console.error(e); }
        }

        async function drinkWater() {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            const r = await fetch(`${backendUrl}/drink_water/${username}`, {method:'POST'});
            updateUI(await r.json());
        }

        async function addXP(amt, el) {
            el.disabled = true;
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            const r = await fetch(`${backendUrl}/add_xp/${username}?amount=${amt}&task_id=${el.id}`, {method:'POST'});
            updateUI(await r.json());
        }

        async function buyReward(cost, name) {
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
            const r = await fetch(`${backendUrl}/buy_reward/${username}?cost=${cost}`, {method:'POST'});
            const data = await r.json();
            if (data.error) {
                tg.showAlert(data.error);
            } else {
                tg.showConfirm(`–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å ${cost} XP –Ω–∞: ${name}?`, (ok) => {
                    if (ok) updateUI(data);
                });
            }
        }

        loadHero();
    </script>
</body>
</html>
