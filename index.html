<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .submenu-enter { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.4s ease-out; }
        .submenu-enter-active { max-height: 500px; opacity: 1; margin-top: 1rem; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased p-4 pb-10">

    <div id="debuff-warning" class="hidden bg-red-900/90 border border-red-500 text-white p-3 rounded-xl mb-4 shadow-lg text-center animate-pulse">
        <p class="font-bold">‚ö†Ô∏è –ò–°–¢–û–©–ï–ù–ò–ï!</p>
        <p class="text-sm">–ó–¥–æ—Ä–æ–≤—å–µ –Ω–∏–∂–µ 30. –í–µ—Å—å –ø–æ–ª—É—á–∞–µ–º—ã–π –æ–ø—ã—Ç —Å–Ω–∏–∂–µ–Ω –Ω–∞ 50%!</p>
    </div>

    <div class="flex justify-between items-center mb-3">
        <div class="flex items-center gap-3">
            <div id="avatar-container" class="w-12 h-12 rounded-full bg-indigo-500 flex items-center justify-center text-xl font-bold overflow-hidden border border-gray-700 shadow-lg">
                <span id="avatar-initial">–ì</span>
            </div>
            <div>
                <h1 id="user-name" class="text-xl font-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <p class="text-gray-400 text-xs">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è: <span id="total-xp" class="text-white font-bold">0</span></p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-xs text-red-400 font-bold mb-1 uppercase tracking-wider">–ó–¥–æ—Ä–æ–≤—å–µ</p>
            <p class="font-bold text-lg"><span id="user-hp">100</span> <span class="text-sm text-gray-500">/ 100</span></p>
        </div>
    </div>

    <div class="w-full bg-gray-800 rounded-full h-2.5 mb-6 shadow-inner border border-gray-700 overflow-hidden">
        <div id="hp-bar" class="bg-gradient-to-r from-red-600 to-red-400 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
    </div>

    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 mb-8 border border-gray-700 shadow-lg relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
        <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold relative z-10">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</p>
        <div class="flex items-end gap-3 mb-2 relative z-10">
            <h2 id="month-xp" class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 transition-all duration-500">0</h2>
            <span class="text-gray-400 mb-2 font-bold">–æ—á–∫–æ–≤</span>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between text-sm relative z-10">
            <span class="text-gray-400">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü:</span>
            <span id="last-month-xp" class="font-bold text-white">0</span>
        </div>
    </div>

    <h2 class="text-lg font-bold mb-4">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏</h2>

    <div class="bg-gray-800 rounded-2xl p-4 mb-4 border border-gray-700 shadow-md">
        <div class="flex justify-between items-center mb-3">
            <h4 class="font-bold text-cyan-400 flex items-center gap-2">üíß –ë–∞–∑–∞: –í–æ–¥–∞</h4>
            <span class="text-amber-400 text-sm font-bold">+5 –û—á–∫–æ–≤</span>
        </div>
        <div class="flex items-center gap-4">
            <button id="btn-water" onclick="drinkWater()" class="bg-cyan-600 hover:bg-cyan-500 active:scale-95 transition-transform text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-lg">
                ü•§
            </button>
            <div class="flex-1">
                <div class="flex justify-between text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span id="water-text">0 / 8 —Å—Ç–∞–∫–∞–Ω–æ–≤</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                    <div id="water-progress" class="bg-cyan-400 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex overflow-x-auto no-scrollbar gap-4 pb-2">
        <button onclick="toggleMenu('menu-sport')" class="min-w-[140px] bg-gray-800 p-4 rounded-2xl border border-gray-700 active:scale-95 transition-transform text-left shadow-md">
            <div class="text-emerald-400 mb-2 text-2xl">üèÉ‚Äç‚ôÇÔ∏è</div>
            <h3 class="font-bold">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
        </button>
        <button onclick="toggleMenu('menu-family')" class="min-w-[140px] bg-gray-800 p-4 rounded-2xl border border-gray-700 active:scale-95 transition-transform text-left shadow-md">
            <div class="text-blue-400 mb-2 text-2xl">üë®‚Äçüë©‚Äçüë¶</div>
            <h3 class="font-bold">–°–µ–º—å—è</h3>
        </button>
    </div>

    <div id="menu-sport" class="submenu-enter bg-gray-800 rounded-2xl p-4 shadow-md">
        <h4 class="font-bold text-emerald-400 mb-3">–ó–∞–¥–∞—á–∏: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
        <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-xl cursor-pointer">
                <input type="checkbox" id="task-run" onclick="addXP(150, this)" class="w-6 h-6 rounded text-emerald-500">
                <span class="flex-1">–ü—Ä–æ–±–µ–∂–∫–∞</span>
                <span class="text-emerald-400 font-bold">+150</span>
            </label>
        </div>
    </div>

    <div id="menu-family" class="submenu-enter bg-gray-800 rounded-2xl p-4 shadow-md">
        <h4 class="font-bold text-blue-400 mb-3">–ó–∞–¥–∞—á–∏: –°–µ–º—å—è</h4>
        <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-xl cursor-pointer">
                <input type="checkbox" id="task-kids" onclick="addXP(100, this)" class="w-6 h-6 rounded text-blue-500">
                <span class="flex-1">–í—Ä–µ–º—è —Å –í–∏—Ç—é—à–µ–π –∏ –î–∏–º—É–ª–µ–π</span>
                <span class="text-emerald-400 font-bold">+100</span>
            </label>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const backendUrl = "https://rpg-backend-yg16.onrender.com";
        let username = "–ì–æ—Å—Ç—å";

        const user = tg.initDataUnsafe?.user;
        if (user) {
            username = user.first_name;
            document.getElementById('user-name').textContent = username;
            const avatarContainer = document.getElementById('avatar-container');
            if (user.photo_url) {
                avatarContainer.innerHTML = `<img src="${user.photo_url}" alt="Avatar" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('avatar-initial').textContent = username.charAt(0).toUpperCase();
            }
        }

        const todayDate = new Date().toDateString();
        // –ü–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç –¢–û–õ–¨–ö–û –≥–∞–ª–æ—á–∫–∏, –≤–æ–¥–∞ —É–¥–∞–ª–µ–Ω–∞ –æ—Ç—Å—é–¥–∞
        let savedData = JSON.parse(localStorage.getItem('rpgTasks_v6')) || { date: '', tasks: [] };

        if (savedData.date !== todayDate) {
            savedData = { date: todayDate, tasks: [] };
            localStorage.setItem('rpgTasks_v6', JSON.stringify(savedData));
        }

        function loadSavedData() {
            savedData.tasks.forEach(taskId => {
                const checkbox = document.getElementById(taskId);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.disabled = true;
                    checkbox.parentElement.style.opacity = '0.5';
                }
            });
        }

        function updateWaterUI(count) {
            document.getElementById('water-text').textContent = `${count} / 8 —Å—Ç–∞–∫–∞–Ω–æ–≤`;
            let percent = (count / 8) * 100;
            document.getElementById('water-progress').style.width = percent + '%';
            
            const btn = document.getElementById('btn-water');
            if (count >= 8) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.innerHTML = '‚úÖ';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'ü•§';
            }
        }

        function updateUI(total_xp, current_month_xp, last_month_xp, hp, water_count) {
            document.getElementById('total-xp').textContent = total_xp;
            document.getElementById('month-xp').textContent = current_month_xp; 
            document.getElementById('last-month-xp').textContent = last_month_xp;
            
            document.getElementById('user-hp').textContent = hp;
            const hpBar = document.getElementById('hp-bar');
            hpBar.style.width = hp + '%';
            
            const warning = document.getElementById('debuff-warning');
            if (hp < 30) {
                hpBar.className = "bg-gradient-to-r from-red-700 to-red-500 h-2.5 rounded-full animate-pulse transition-all duration-500";
                warning.classList.remove('hidden');
            } else {
                hpBar.className = "bg-gradient-to-r from-red-500 to-rose-400 h-2.5 rounded-full transition-all duration-500";
                warning.classList.add('hidden');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–¥—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã!
            updateWaterUI(water_count);
        }

        async function loadHero() {
            try {
                let response = await fetch(`${backendUrl}/get_hero/${username}`);
                let data = await response.json();
                updateUI(data.total_xp, data.current_month_xp, data.last_month_xp, data.hp, data.water_count);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error);
            }
        }

        async function drinkWater() {
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            
            // –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–æ–¥—É –ª–æ–∫–∞–ª—å–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            try {
                let response = await fetch(`${backendUrl}/drink_water/${username}`, { method: 'POST' });
                let data = await response.json();
                updateUI(data.total_xp, data.current_month_xp, data.last_month_xp, data.hp, data.water_count);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error);
            }
        }

        async function addXP(amount, element) {
            const taskId = element.id;
            element.checked = true;
            element.disabled = true;
            element.parentElement.style.opacity = '0.5';
            
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            if (!savedData.tasks.includes(taskId)) {
                savedData.tasks.push(taskId);
                localStorage.setItem('rpgTasks_v6', JSON.stringify(savedData));
            }

            try {
                let response = await fetch(`${backendUrl}/add_xp/${username}?amount=${amount}`, { method: 'POST' });
                let data = await response.json();
                updateUI(data.total_xp, data.current_month_xp, data.last_month_xp, data.hp, data.water_count);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", error);
            }
        }

        function toggleMenu(menuId) {
            const allMenus = document.querySelectorAll('.submenu-enter');
            allMenus.forEach(menu => {
                if(menu.id !== menuId) menu.classList.remove('submenu-enter-active');
            });
            document.getElementById(menuId).classList.toggle('submenu-enter-active');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        loadHero();
        loadSavedData();
    </script>
</body>
</html>
